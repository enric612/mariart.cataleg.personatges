
<!DOCTYPE html>
<html lang="ca">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Personajes MariArT</title>

    <!-- Fonts to resemble mariartnatural.es -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Montserrat:wght@300;500;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="navbar-scroll.js"></script>

    <script>
        // Configuració personalitzada per a Tailwind CSS
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fons': '#F5EFE6',       // Un beix molt clar per al fons
                        'targeta': '#E8DFCA',    // Un to lleugerament més fosc per a targetes
                        'text-principal': '#785A48', // Marró fosc per al text principal
                        'text-secundari': '#A98F7A', // Marró més suau per a subtítols
                        'accent': '#B48369',       // Un to terracota per a botons i accents
                        'accent-hover': '#9C6F5A',  // Versió més fosca per a l'hover de l'accent
                    },
                    fontFamily: {
                        sans: ['"Segoe UI"', 'Tahoma', 'Geneva', 'Verdana', 'sans-serif'],
                    },
                    borderRadius: {
                        '2xl': '1rem',
                        '3xl': '1.5rem',
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        body {
            @apply bg-fons text-text-principal antialiased;
        }
        .fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Estil per al contenidor de la imatge */
        .image-container {
            @apply relative w-full h-80;
        }
        .image-placeholder {
            @apply absolute inset-0 bg-targeta/50 animate-pulse; /* Placeholder visible durant la càrrega */
        }
    </style>

    <!-- Plain CSS fallback so the banner and placeholders are visible without Tailwind @apply -->
    <style>
        /* Image container and placeholder (fallback for @apply) */
        .image-container { position: relative; width: 100%; height: 20rem; }
        .image-placeholder { position: absolute; inset: 0; background: #E8DFCA; opacity: 0.6; }

    /* Banner styles (plain CSS) */
    .banner-wrap{position:relative;width:100%;overflow:hidden;height:600px;max-height:600px}
    /* Slide wrapper (each slide is absolute and holds an img + overlay) */
    .banner-slide{position:absolute;left:0;top:0;width:100%;height:100%;transition:opacity .6s ease,transform .6s ease}
    .banner-slide img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center center;
        display: block;
        margin: 0;
        box-shadow: 0 4px 24px rgba(0,0,0,0.12);
        border-radius: 0;
        background: rgba(255,255,255,0.12);
        transition: box-shadow 0.3s;
        position: absolute;
        top: 0;
        left: 0;
        transform: none;
    }
    .banner-inner{position:relative;width:100%;height:100%}
    /* overlay gradient at bottom for caption readability */
    .banner-overlay{position:absolute;left:0;right:0;bottom:0;height:45%;background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.45) 60%, rgba(0,0,0,0.6) 100%);pointer-events:none}
    .banner-caption{position:absolute;left:6%;bottom:28px;color:white;text-align:left;pointer-events:auto;z-index:3;max-width:60%}
    .banner-caption h3{margin:0;font-size:clamp(20px,3.2vw,34px);font-weight:700;letter-spacing:0.2px;font-family:'Playfair Display',serif}
    .banner-caption .banner-sub{font-size:13px;opacity:0.95;margin-top:6px;font-family:'Montserrat',sans-serif}
    .banner-cta{display:inline-block;margin-top:8px;padding:8px 14px;border-radius:999px;background:rgba(255,255,255,0.95);color:#2b2b2b;font-weight:600;text-decoration:none}

    /* Link styling for product name in banner */
    .banner-caption a.banner-link{
        color: inherit;
        text-decoration: none; /* no underline per user preference */
        cursor: pointer;
        pointer-events: auto;
        display: inline-block;
    }
    .banner-caption a.banner-link:hover{ opacity: 0.95; color: #FFD24D; }
    .banner-arrows{position:absolute;top:50%;left:0;right:0;display:flex;justify-content:space-between;transform:translateY(-50%);pointer-events:none;padding:0 12px}
    .banner-arrow{pointer-events:auto;background:rgba(255,255,255,0.95);border-radius:999px;padding:8px 12px;margin:8px;color:#333;border:none;box-shadow:0 6px 18px rgba(0,0,0,0.18);cursor:pointer}
    .banner-dots{position:absolute;left:50%;transform:translateX(-50%);bottom:14px;display:flex;gap:10px}
    .banner-dot{width:12px;height:12px;border-radius:999px;background:rgba(255,255,255,0.7);cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.12)}
    .banner-dot.active{background:rgba(255,255,255,1);transform:scale(1.05)}
    /* Ensure banner sits above other content */
    .banner-wrap { z-index: 1; }
    /* Hero title positioned above the banner (overlay) */
    .site-hero{
        position: absolute;
        top: 20px;
        left: 6%;
        z-index: 60; /* sits above the banner which has z-index:1 */
        pointer-events: none; /* clickable elements remain under it */
    }
    .site-hero h1{
        font-family:'Playfair Display', serif;
        font-size: clamp(28px, 4.5vw, 64px);
        color: #FFD24D; /* yellow text */
        background: none; /* remove yellow box */
        padding: 0;
        margin: 0;
        display: inline;
        font-weight: 700;
        text-shadow: 0 2px 6px rgba(0,0,0,0.22);
        pointer-events: auto;
    }
    html, body { background: #F5EFE6; color: #785A48; }
    body{font-family:'Montserrat',sans-serif}
    /* Top navigation bar styles (plain CSS) */
    .site-navbar{
        --navbar-height: 96px;
        --navbar-gap: 8px; /* small gap between navbar and content when solid */
        height: var(--navbar-height);
        position:fixed;
        top:0;
        left:0;
        width:100%;
        z-index:70; /* above hero overlay */
        background: transparent; /* start transparent over the hero */
        transition: background 0.28s ease, box-shadow 0.28s ease, backdrop-filter 0.28s ease;
        backdrop-filter: blur(4px);
        padding: 8px 0;
        pointer-events: auto;
    }
    /* When scrolled or hovered, make navbar solid white */
    .site-navbar.scrolled, .site-navbar:hover{
        background: #ffffff;
        box-shadow: 0 6px 24px rgba(0,0,0,0.08);
    }
    /* When the navbar is in 'solid' mode (non-home), make it part of the document flow
       so it does not overlay page content and always appears white. */
    .site-navbar.solid{
        /* keep fixed but make visually solid; body will receive padding so content isn't hidden */
        position: fixed;
        background: #ffffff;
        box-shadow: 0 6px 24px rgba(0,0,0,0.06);
        z-index: 90;
    }
    .site-navbar.solid .navbar-title, .site-navbar.solid .navbar-link{ color: #332100; }

    /* Use only #app-content margin to offset content below the fixed navbar (avoid double offsets) */
    body.nav-solid #app-content { margin-top: calc(var(--navbar-height) + var(--navbar-gap)); }

    /* Hide the overlayed site hero when the navbar is solid so it doesn't block headers or back buttons */
    body.nav-solid .site-hero{ display: none !important; }

    /* Responsive: slightly smaller navbar on small screens */
    @media (max-width: 640px){
        .site-navbar{ --navbar-height: 64px; }
        body.nav-solid{ padding-top: calc(var(--navbar-height) + var(--navbar-gap)); }
    }
    .navbar-content{
        max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:6px 24px;
    }
    .navbar-title{
        font-family:'Playfair Display',serif;font-weight:700;font-size:clamp(20px,3.6vw,44px);color:#FFD24D;text-decoration:none;display:inline-block;pointer-events:auto;transition:color 0.2s ease;line-height:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:78%;
    }
    .site-navbar.solid .navbar-title{ font-size: clamp(16px,2.8vw,28px); }
    /* On white background use dark title */
    .site-navbar.scrolled .navbar-title, .site-navbar:hover .navbar-title{ color: #332100; }
    .navbar-link{ font-family:'Montserrat',sans-serif;color:#fff;text-decoration:none;margin-left:16px;padding:6px 12px;border-radius:8px;transition:color 0.18s, background 0.18s; }
    /* When navbar becomes white, links should be dark */
    .site-navbar.scrolled .navbar-link, .site-navbar:hover .navbar-link{ color:#332100; }
    .navbar-link:hover{ background: rgba(255,210,77,0.12); }
    /* Fixed back button used on product detail views */
    .fixed-back-btn{
        width:48px;height:48px;border-radius:12px;background:#B48369;border:none;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(0,0,0,0.12);cursor:pointer;position:fixed;left:18px;bottom:18px;z-index:120;color:#fff
    }
    .fixed-back-btn:hover{ transform:translateY(-2px); }
    .top-back-link{
        position:fixed;top:calc(var(--navbar-height) + 12px);left:18px;z-index:115;background:#fff;padding:8px 12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.08);color:#332100;text-decoration:none;font-weight:600}
    .top-back-link:hover{ transform:translateY(-2px); }
    </style>
</head>

<body>


        <div id="root"></div>


    <script type="text/babel">
        // --- Botó flotant Instagram ---
        function FloatingSocialButtons() {
            // Contenidor comú per als dos botons, en fila
            const containerStyle = {
                position: 'fixed',
                right: '1.2rem',
                bottom: '1.2rem', // Ara més avall, a prop de la cantonada
                zIndex: 100,
                display: 'flex',
                flexDirection: 'row',
                gap: '0.7rem',
                alignItems: 'center',
            };
            const btnStyle = {
                width: '56px',
                height: '56px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                boxShadow: '0 4px 16px rgba(0,0,0,0.15)',
                background: 'transparent',
                borderRadius: '16px',
                transition: 'transform 0.2s',
                padding: 0,
            };
            const iconStyle = {
                width: '40px',
                height: '40px',
                objectFit: 'contain',
            };
            // Afegim la fletxa de pujar al costat dret si cal
            const [showScrollBtn, setShowScrollBtn] = React.useState(false);
            React.useEffect(() => {
                const handleScroll = () => {
                    setShowScrollBtn(window.scrollY > 50);
                };
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);
            // Nova fletxa cap a l'esquerra per tornar enrere
            const { vista, onBack } = window._floatingSocialButtonsProps || {};
            return (
                <div style={containerStyle}>
                    <a
                        href="https://instagram.com/mariart_natural"
                        target="_blank"
                        rel="noopener noreferrer"
                        title="Segueix-nos a Instagram"
                        style={btnStyle}
                        onMouseOver={e => e.currentTarget.style.transform = 'scale(1.12)'}
                        onMouseOut={e => e.currentTarget.style.transform = 'scale(1)'}
                    >
                        <img src="/imatges/instagram.webp" alt="Instagram" style={iconStyle} />
                    </a>
                    <a
                        href="https://wa.me/34657626290"
                        target="_blank"
                        rel="noopener noreferrer"
                        title="Contacta per WhatsApp"
                        style={btnStyle}
                        onMouseOver={e => e.currentTarget.style.transform = 'scale(1.12)'}
                        onMouseOut={e => e.currentTarget.style.transform = 'scale(1)'}
                    >
                        <img src="/imatges/whatsapp.webp" alt="WhatsApp" style={iconStyle} />
                    </a>
                    {showScrollBtn && (
                        <>
                            {(vista === 'productes' || vista === 'detall') && (
                                <button
                                    onClick={onBack}
                                    title="Tornar al llistat anterior"
                                    style={{
                                        marginRight: '0.7rem',
                                        width: '56px',
                                        height: '56px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        background: 'transparent',
                                        border: 'none',
                                        borderRadius: '16px',
                                        boxShadow: '0 4px 16px rgba(0,0,0,0.15)',
                                        cursor: 'pointer',
                                        transition: 'transform 0.2s',
                                    }}
                                    onMouseOver={e => e.currentTarget.style.transform = 'scale(1.12)'}
                                    onMouseOut={e => e.currentTarget.style.transform = 'scale(1)'}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="#B48369" viewBox="0 0 24 24"><path d="M4 12l8-7v4h8v6h-8v4z"/></svg>
                                </button>
                            )}
                            <button
                                onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
                                title="Subir arriba"
                                style={{
                                    marginLeft: '0.7rem',
                                    width: '56px',
                                    height: '56px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    background: 'transparent',
                                    border: 'none',
                                    borderRadius: '16px',
                                    boxShadow: '0 4px 16px rgba(0,0,0,0.15)',
                                    cursor: 'pointer',
                                    transition: 'transform 0.2s',
                                }}
                                onMouseOver={e => e.currentTarget.style.transform = 'scale(1.12)'}
                                onMouseOut={e => e.currentTarget.style.transform = 'scale(1)'}
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="#B48369" viewBox="0 0 24 24"><path d="M12 4l-7 8h4v8h6v-8h4z"/></svg>
                            </button>
                        </>
                    )}
                </div>
            );
        }
        const { useState, useEffect } = React;
        // --- Component Auxiliar per a Càrrega Lazy amb Placeholder ---
        function LazyImage({ src, alt, className, loading }) {
            const [loaded, setLoaded] = useState(false);

            return (
                <div className="image-container">
                    {/* El Placeholder es mostra mentre la imatge no ha acabat de carregar */}
                    {!loaded && (
                        <div className="image-placeholder"></div>
                    )}

                    <img
                        src={src}
                        alt={alt}
                        className={`${className} ${loaded ? 'opacity-100' : 'opacity-0'} transition-opacity duration-700`}
                        loading={loading}
                        onLoad={() => setLoaded(true)}
                        style={{ position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', objectFit: 'cover', objectPosition: 'center 30%' }}
                    />
                </div>
            );
        }

        // ----------------------------------------------------------------------
        // --- Component de la Vista Detallada (NIVELL 3) - AMB SUPORT DE VÍDEO ---
        // ----------------------------------------------------------------------
        function VistaDetall({ producte, onTorna }) {
            // Si hi ha videoUrl, el recurs actiu inicial és l'URL del vídeo, sinó és la primera imatge
            const initialSource = producte.videoUrl || producte.imatges[0];
            const [imatgeActiva, setImatgeActiva] = useState(initialSource);
            useEffect(() => { document.title = producte.nom; }, [producte]);

            // Comprova si el recurs actual és un vídeo (utilitzat per la renderització condicional)
            const isVideoActive = producte.videoUrl && imatgeActiva === producte.videoUrl;

            return (
                <div className="container mx-auto px-4 py-10 fade-in">
                    <header className="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                        <h1 className="text-4xl md:text-5xl font-bold text-text-principal text-center sm:text-left">{producte.nom}</h1>
                        <button onClick={onTorna} className="flex items-center gap-2 bg-accent text-white font-bold py-3 px-6 rounded-2xl hover:bg-accent-hover transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-1">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clipRule="evenodd" /></svg>
                            Volver a {producte.categoriaNom}
                        </button>
                    </header>
                        <a onClick={(e)=>{e.preventDefault(); onTorna();}} href="#" className="top-back-link">
                            Volver a {producte.categoriaNom || 'categorías'}
                        </a>

                    <div className="bg-white p-4 sm:p-6 rounded-3xl shadow-lg mb-8">

                        {isVideoActive ? (
                            // CAS 1: MOSTRAR VÍDEO OPTIMITZAT (MP4/WebM)
                            <video
                                key={producte.videoUrl} // Utilitzem key per re-renderitzar quan canvia la font
                                className="w-full max-h-[70vh] object-contain rounded-2xl mx-auto"
                                autoPlay
                                loop
                                muted // Obligatori per a l'autoplay a molts navegadors
                                playsInline // Recomanat per a mòbils
                                poster={producte.imatges[0]} // WebP estàtic per a la previsualització
                                loading="eager"
                            >
                                <source src={producte.videoUrl} type="video/webm" />
                                {/* Fallback a imatge estàtica per a navegadors sense suport o error */}
                                <img src={producte.imatges[0]} alt={producte.nom} />
                            </video>
                        ) : (
                            // CAS 2: MOSTRAR IMATGE ESTÀTICA (WebP)
                            <img
                                src={imatgeActiva}
                                alt={`Imatge principal de ${producte.nom}`}
                                className="w-full max-h-[70vh] object-contain rounded-2xl mx-auto"
                                loading="eager"
                            />
                        )}
                    </div>

                    <div className="flex gap-4 justify-center flex-wrap">

                        {/* BOTÓ ADDICIONAL PER SELECCIONAR EL VÍDEO (si existeix) */}
                        {producte.videoUrl && (
                            <div
                                key="video-btn"
                                className={`w-24 h-24 flex items-center justify-center bg-targeta rounded-2xl cursor-pointer border-4 transition-all duration-300 hover:scale-105 hover:shadow-md ${producte.videoUrl === imatgeActiva ? 'border-accent shadow-lg' : 'border-transparent'}`}
                                onClick={() => setImatgeActiva(producte.videoUrl)}
                                title="Mostrar animación"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-text-principal" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clipRule="evenodd" />
                                </svg>
                            </div>
                        )}

                        {/* MINIATURES D'IMATGES ESTÀTIQUES */}
                        {producte.imatges.map((imgSrc, index) => (
                            <img
                                key={index}
                                src={imgSrc}
                                alt={`Miniatura ${index + 1}`}
                                className={`w-24 h-24 object-cover rounded-2xl cursor-pointer border-4 transition-all duration-300 hover:scale-105 hover:shadow-md ${imgSrc === imatgeActiva ? 'border-accent shadow-lg' : 'border-transparent'}`}
                                onClick={() => setImatgeActiva(imgSrc)}
                                loading="eager" // Es carreguen eager, ja que estem a la vista detallada
                            />
                        ))}
                    </div>
                </div>
            );
        }

        // ----------------------------------------------------------------------
        // --- Component del Llistat de Productes (NIVELL 2) ---
        // ----------------------------------------------------------------------
        function LlistatProductesPerCategoria({ categoria, onProducteClick, onTorna }) {
            useEffect(() => {
                document.title = `Catálogo - ${categoria.nom}`;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, [categoria]);

            const [showScrollBtn, setShowScrollBtn] = React.useState(false);
            React.useEffect(() => {
                const handleScroll = () => {
                    setShowScrollBtn(window.scrollY > 50);
                };
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            return (
                <main className="fade-in">
                    <header className="text-center py-8 px-4">
                        <h1 className="text-5xl md:text-6xl font-extrabold text-text-principal">{categoria.nom}</h1>
                        <p className="text-xl text-text-secundari mt-2 max-w-2xl mx-auto">Todos los personajes de nuestra colección de {categoria.nom}.</p>
                        <button onClick={onTorna} className="mt-4 flex items-center gap-1 mx-auto text-accent hover:text-accent-hover font-medium transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clipRule="evenodd" /></svg>
                            Volver a categorías
                        </button>
                    </header>
                    <div className="container mx-auto px-4 sm:px-8">
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                            {categoria.productes.map(producte => (
                                <div key={producte.nom} className="bg-white rounded-3xl overflow-hidden shadow-lg cursor-pointer group transition-all duration-300 hover:shadow-2xl hover:-translate-y-2" onClick={() => onProducteClick({ ...producte, categoriaNom: categoria.nom })}>
                                    <div className="overflow-hidden">
                                        {/* Ús del component LazyImage amb loading="lazy" */}
                                        <LazyImage
                                            src={producte.imatges[0]}
                                            alt={producte.nom}
                                            className="w-full h-80 object-cover transition-transform duration-500 group-hover:scale-110"
                                            loading="lazy"
                                        />
                                    </div>
                                    <div className="p-6 text-center">
                                        <h3 className="text-2xl font-bold text-text-principal">{producte.nom}</h3>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </main>
            );
        }

        // ----------------------------------------------------------------------
        // --- Component del Llistat de Categories (NIVELL 1) ---
        // ----------------------------------------------------------------------
        function LlistatCategories({ categories, onCategoriaClick }) {
            useEffect(() => { document.title = "Catálogo de Personajes MariArT"; }, []);


            const [showScrollBtn, setShowScrollBtn] = React.useState(false);
            React.useEffect(() => {
                const handleScroll = () => {
                    setShowScrollBtn(window.scrollY > 50);
                };
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            return (
                <main className="fade-in">
                    <header className="text-center py-12 px-4">
                        { /* Main title removed here because site-hero is now overlayed above the banner */ }
                        <p className="text-xl text-text-secundari mt-4 max-w-2xl mx-auto">Selecciona una categoria para explorar nuestros diseños.</p>
                    </header>
                    <div className="container mx-auto px-4 sm:px-8">
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                            {categories.map(categoria => (
                                <div key={categoria.nom} className="bg-white rounded-3xl overflow-hidden shadow-lg cursor-pointer group transition-all duration-300 hover:shadow-2xl hover:-translate-y-2" onClick={() => onCategoriaClick(categoria)}>
                                    <div className="overflow-hidden">
                                        {/* Ús del component LazyImage amb loading="lazy" */}
                                        <LazyImage
                                            src={categoria.productes[0]?.imatges[0] || '/imatges/placeholder.webp'}
                                            alt={`Categoria ${categoria.nom}`}
                                            className="w-full h-80 object-cover transition-transform duration-500 group-hover:scale-110"
                                            loading="lazy"
                                        />
                                    </div>
                                    <div className="p-6 text-center">
                                        <h3 className="text-2xl font-bold text-text-principal">{categoria.nom}</h3>
                                        <p className="text-text-secundari mt-1 text-sm">{categoria.productes.length} producto{categoria.productes.length > 1 ? "s" : ""}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </main>
            );
        }


        // --- Component Principal de l'Aplicació ---
        function Loader() {
            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    width: '100vw',
                    height: '100vh',
                    background: 'rgba(245,239,230,0.85)',
                    zIndex: 9999,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                }}>
                    <div style={{
                        width: '64px',
                        height: '64px',
                        border: '8px solid #E8DFCA',
                        borderTop: '8px solid #B48369',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite',
                    }} />
                    <style>{`@keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }`}</style>
                </div>
            );
        }

        function App() {
            // Estats de navegació: 'categories', 'productes', 'detall'
            const [vista, setVista] = useState('categories');
            const [categoriaSeleccionada, setCategoriaSeleccionada] = useState(null);
            const [producteSeleccionat, setProducteSeleccionat] = useState(null);
            const [categoryData, setCategoryData] = useState({ categories: [] });
            const [loading, setLoading] = useState(true);
            const [loadError, setLoadError] = useState(false);

            // fetch with error handling and retry support
            function fetchCategories(){
                setLoading(true);
                setLoadError(false);
                fetch('categories.json')
                    .then(res => {
                        if(!res.ok) throw new Error('HTTP ' + res.status);
                        return res.json();
                    })
                    .then(data => {
                        setCategoryData(data || { categories: [] });
                    })
                    .catch(err => {
                        console.error('Failed to load categories.json', err);
                        setCategoryData({ categories: [] });
                        setLoadError(true);
                    })
                    .finally(() => setLoading(false));
            }

            useEffect(() => {
                fetchCategories();
            }, []);
            const categories = categoryData.categories;

            // Ensure the page receives top padding when the navbar should be solid (non-home)
            React.useEffect(() => {
                if(typeof document !== 'undefined'){
                    if(vista !== 'categories'){
                        document.body.classList.add('nav-solid');
                    } else {
                        document.body.classList.remove('nav-solid');
                    }
                }
                return () => {};
            }, [vista]);

            // Measure the navbar height and update CSS variable so offsets are accurate
            React.useEffect(() => {
                function updateNavbarHeight(){
                    try{
                        const nav = document.getElementById('site-navbar');
                        if(nav){
                            let h = nav.getBoundingClientRect().height || 72;
                            // add a small buffer so content won't be flush under the bar
                            h = Math.ceil(h) + 8;
                            // clamp to a sensible range to avoid huge offsets
                            const minH = 56, maxH = 140;
                            const capped = Math.max(minH, Math.min(h, maxH));
                            document.documentElement.style.setProperty('--navbar-height', `${capped}px`);
                        }
                    }catch(e){ console.warn(e); }
                }
                updateNavbarHeight();
                window.addEventListener('resize', updateNavbarHeight);
                // also update after a short delay in case fonts or rendering change
                const t = setTimeout(updateNavbarHeight, 350);
                return () => { window.removeEventListener('resize', updateNavbarHeight); clearTimeout(t); };
            }, [vista, loading]);

            const handleCategoriaClick = (categoria) => {
                setLoading(true);
                setTimeout(() => {
                    setCategoriaSeleccionada(categoria);
                    setVista('productes');
                    setLoading(false);
                }, 350);
            };

            const handleProducteClick = (producte) => {
                setLoading(true);
                setTimeout(() => {
                    // ensure the product carries the category name so the detail view can show "Volver a [categoria]"
                    const withCategory = { ...producte, categoriaNom: (categoriaSeleccionada && categoriaSeleccionada.nom) || producte.categoriaNom || '' };
                    setProducteSeleccionat(withCategory);
                    setVista('detall');
                    setLoading(false);
                }, 350);
            };

            const handleTornaAlLlistatDeProductes = () => {
                setLoading(true);
                setTimeout(() => {
                    setProducteSeleccionat(null);
                    setVista('productes');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    setLoading(false);
                }, 350);
            };

            const handleTornaAlLlistatDeCategories = () => {
                setLoading(true);
                setTimeout(() => {
                    setCategoriaSeleccionada(null);
                    setProducteSeleccionat(null);
                    setVista('categories');
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    setLoading(false);
                }, 350);
            };

            let content;

            // --- Banner de Destaçats ---
            function Banner({ items, interval = 3000 }) {
                const [index, setIndex] = useState(0);
                const count = items.length;
                const timerRef = React.useRef(null);
                const startX = React.useRef(null);

                useEffect(() => {
                    if (count === 0) return;
                    clearInterval(timerRef.current);
                    timerRef.current = setInterval(() => {
                        setIndex(i => (i + 1) % count);
                    }, interval);
                    return () => clearInterval(timerRef.current);
                }, [count, interval]);

                function goTo(i) {
                    setIndex(((i % count) + count) % count);
                    clearInterval(timerRef.current);
                }

                function prev() { goTo(index - 1); }
                function next() { goTo(index + 1); }

                function onTouchStart(e) { startX.current = e.touches[0].clientX; }
                function onTouchEnd(e) {
                    if (startX.current == null) return;
                    const dx = e.changedTouches[0].clientX - startX.current;
                    if (Math.abs(dx) > 40) {
                        if (dx < 0) next(); else prev();
                    }
                    startX.current = null;
                    }

                    return (
                    <section className="w-full">
                        <div className="banner-wrap" onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
                            <div className="banner-inner">
                                {items.map((it, i) => (
                                    <div key={i} className="banner-slide" style={{ opacity: i === index ? 1 : 0, transform: `translateX(${(i - index) * 6}%)`, pointerEvents: i === index ? 'auto' : 'none' }}>
                                        <img src={it.imatge} alt={it.nom} loading="lazy" />
                                        <div className="banner-overlay" />
                                        <div className="banner-caption">
                                            <h3>
                                                <a href="#" className="banner-link" aria-label={`Veure ${it.nom}`} onClick={(e)=>{ e.preventDefault(); console.log('banner link clicked:', it); try{ if(window._appApi && window._appApi.openProduct){ window._appApi.openProduct(it); } else if(window._openProduct){ window._openProduct(it); } }catch(err){ console.warn(err); } }}>
                                                    {it.nom}
                                                </a>
                                            </h3>
                                            <div className="banner-sub">{it.categoria}</div>
                                        </div>
                                    </div>
                                ))}
                                <div className="banner-arrows">
                                    <button aria-label="Anterior" className="banner-arrow" onClick={prev}>&lt;</button>
                                    <button aria-label="Seguent" className="banner-arrow" onClick={next}>&gt;</button>
                                </div>
                                <div className="banner-dots">
                                    {items.map((_, i) => (
                                        <div key={i} role="button" tabIndex={0} onClick={() => goTo(i)} className={`banner-dot ${i === index ? 'active' : ''}`}></div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </section>
                );
            }

            if (vista === 'detall' && producteSeleccionat) {
                content = <VistaDetall producte={producteSeleccionat} onTorna={handleTornaAlLlistatDeProductes} categoriaNom={categoriaSeleccionada?.nom} />;
            } else if (vista === 'productes' && categoriaSeleccionada) {
                content = <LlistatProductesPerCategoria categoria={categoriaSeleccionada} onProducteClick={handleProducteClick} onTorna={handleTornaAlLlistatDeCategories} />;
            } else {
                // Recopilar productes destacats configurables (camp `destacat: true` a categories.json)
                let featured = [];
                categories.forEach(cat => {
                    (cat.productes || []).forEach(prod => {
                        if (prod.destacat) {
                            featured.push({ nom: prod.nom, imatge: prod.imatges && prod.imatges[0] ? prod.imatges[0] : '/imatges/placeholder.webp', categoria: cat.nom, raw: prod, destacatOrder: prod.destacatOrder ?? 999 });
                        }
                    });
                });
                featured = featured.sort((a, b) => (a.destacatOrder ?? 999) - (b.destacatOrder ?? 999));
                console.log('Featured for banner:', featured);

                content = (
                    <div>
                        {featured.length > 0 && <Banner items={featured} interval={3000} />}
                        <LlistatCategories categories={categories} onCategoriaClick={handleCategoriaClick} />
                    </div>
                );
            }

            window._floatingSocialButtonsProps = {
                vista,
                onBack: vista === 'detall' ? handleTornaAlLlistatDeProductes : handleTornaAlLlistatDeCategories
            };
            // Expose a small API so banner CTA can open products in-app
            window._appApi = window._appApi || {};
            window._appApi.openProduct = function(item){
                // try to find the product in loaded categories
                for(const cat of categories || []){
                    const prod = (cat.productes||[]).find(p=>p.nom === item.nom);
                    if(prod){
                        setCategoriaSeleccionada(cat);
                        setProducteSeleccionat({...prod, categoriaNom: cat.nom});
                        setVista('detall');
                        return;
                    }
                }
                console.log('Product not found in categories yet:', item);
            };
            // global helper so banner CTA can open product inside the React app
            window._openProduct = function(item){
                try{
                    // if the app exposes a navigation API, use it
                    if(window._appApi && window._appApi.openProduct){
                        window._appApi.openProduct(item);
                        return;
                    }
                    // fallback: find matching category and product and simulate click by setting state via window (not ideal)
                    // This will be implemented if needed; for now we just console log
                    console.log('Open product requested:', item);
                }catch(e){ console.warn(e); }
            }
            return (
                <div>
                    {/* Global site navbar - rendered on every view */}
                    <nav id="site-navbar" className={`site-navbar ${vista === 'categories' ? '' : 'solid'}`}>
                        <div className="navbar-content">
                            <a href="#" className="navbar-title" onClick={e => {e.preventDefault(); setCategoriaSeleccionada(null); setProducteSeleccionat(null); setVista('categories'); window.scrollTo({top:0,behavior:'smooth'});}}>
                                CATÁLOGO DE PERSONAJES
                            </a>
                            <a href="#" className="navbar-link" onClick={e => {e.preventDefault(); setCategoriaSeleccionada(null); setProducteSeleccionat(null); setVista('categories'); window.scrollTo({top:0,behavior:'smooth'});}}>Inici</a>
                        </div>
                    </nav>
                    <div id="app-content">
                        {loading && <Loader />}
                        {!loading && content}
                        <FloatingSocialButtons />
                        <footer className="text-center py-8 mt-10">
                            <p className="text-text-secundari">&copy; {new Date().getFullYear()} MariArT</p>
                        </footer>
                    </div>
                </div>
            );
        }

        // --- Renderitzar l'aplicació ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    
</body>

</html>